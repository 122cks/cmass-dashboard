# 📊 시장점유율 계산 방식 설명

## 🎯 핵심 원리

**모든 분석 페이지에서 정확한 시장 규모를 기반으로 점유율을 계산합니다.**

---

## 1️⃣ 도서(과목)별 시장 규모 계산

### 📘 계산 방식 (`utils/market_size_v2.py`)

```python
각 도서코드별로:

1. 학년도 주문 패턴 분석
   - 2025년 + 2026년 모두 주문 → 1학년 편성
   - 2026년만 주문 → 2학년 편성  
   - 2025년만 주문 → 1학년 편성

2. 시장 규모 계산
   - 해당 도서를 주문한 학교들의
   - 배정된 학년(1학년 또는 2학년)의 학생수만 합산
   
3. 점유율 계산
   점유율 = (주문 부수 / 해당 학년 학생수) × 100
```

### 💡 예시

**도서: 한국사 1** (도서코드 462681)
- 학년도 패턴: 2025년+2026년 주문 → **1학년 편성**
- A고등학교: 1학년 325명, 주문 300부
- B고등학교: 1학년 281명, 주문 270부
- **시장 규모 = 325 + 281 = 606명** *(2학년, 3학년 학생수 제외!)*
- **주문 부수 = 570부**
- **점유율 = 570 / 606 = 94.1%**

---

## 2️⃣ 지역별 시장 규모

### 📍 계산 방식

```python
각 지역(시도교육청)별로:

1. 해당 지역 학교들의 학생수 집계
2. 해당 지역 주문 현황 집계
3. 도서별 배정 학년 고려
   - 1학년 편성 도서 → 1학년 학생수만
   - 2학년 편성 도서 → 2학년 학생수만

점유율 = (지역 주문 부수 / 지역 해당 학년 학생수) × 100
```

---

## 3️⃣ 총판별 시장 규모

### 🏢 계산 방식 (`utils/market_size_distributor.py`)

```python
각 총판별로:

1. 담당 학교 파악
   - 2025년도_학년별·학급별 학생수.csv의 '담당총판' 컬럼 활용

2. 총판이 주문한 도서별 학년도 패턴 분석
   - 2025+2026년 주문 → 1학년 편성
   - 2026년만 주문 → 2학년 편성

3. 시장 규모 계산
   - 담당 학교 중 해당 학년 학생수만 합산
   - 중학교 1학년 편성 → 중학교 1학년 학생수만
   - 고등학교 2학년 편성 → 고등학교 2학년 학생수만

점유율 = (총판 주문 부수 / 담당 학교 해당 학년 학생수) × 100
```

### 💡 예시

**총판: 강남)푸른언덕**
- 담당 학교: 개포고(1학년 198명), 경기고(1학년 325명) 등
- 한국사 1 주문 → 1학년 편성
- **시장 규모 = 담당 학교들의 1학년 학생수만 합산**
- **점유율 = 주문 부수 / 담당 학교 1학년 학생수**

---

## 4️⃣ 비교 분석

### 🔍 A/B 비교 분석

```python
두 그룹(지역/총판/과목) 비교 시:

1. 각 그룹의 시장 규모 별도 계산
2. 각 그룹의 주문 현황 집계
3. 각각의 점유율 계산 후 비교

예: 서울 vs 부산
- 서울 시장 = 서울 학교들의 해당 학년 학생수
- 부산 시장 = 부산 학교들의 해당 학년 학생수
- 각각 독립적으로 점유율 계산
```

---

## 5️⃣ 등급별 분석

### 🏅 계산 방식

```python
총판 등급(S, A, B, C 등)별로:

1. 해당 등급 총판들의 담당 학교 파악
2. 도서별 배정 학년 분석
3. 담당 학교들의 해당 학년 학생수 합산
4. 등급별 주문 부수 집계

점유율 = (등급별 주문 부수 / 등급별 담당 학교 해당 학년 학생수) × 100
```

---

## 🔑 핵심 데이터 소스

### 📂 사용 파일

1. **2025년도_학년별·학급별 학생수(초중고)_전체.csv**
   - 학교별 학년별 학생수
   - 담당총판 정보
   - 학교급 정보 (중학교/고등학교)

2. **씨마스_22개정 주문현황_학교코드총판코드.csv**
   - 학교별 도서별 주문 현황
   - 학년도 정보 (2025/2026)
   - 주문 부수, 금액

3. **제품정보.csv**
   - 도서코드별 학교급 (중학교/고등학교)
   - 교과서명, 교과군

---

## 📊 적용 페이지

### ✅ 시장점유율 표시 페이지

1. **📚 교과/과목별 분석** (`pages/1_📚_교과과목별_분석.py`)
   - 과목별 시장 규모 및 점유율
   - 교과군별 점유율
   - 중등/고등 분리 점유율

2. **🗺️ 지역별 분석** (`pages/2_🗺️_지역별_분석.py`)
   - 시도교육청별 점유율
   - 교육지원청별 점유율
   - 지역 간 점유율 비교

3. **🏢 총판별 분석** (`pages/3_🏢_총판별_분석.py`)
   - 총판별 담당 시장 점유율
   - 목표 대비 실적 (목표1 + 목표2)
   - 효율성 분석

4. **🔍 비교 분석** (`pages/5_🔍_비교_분석.py`)
   - A/B 지역 점유율 비교
   - 총판 간 점유율 비교
   - 과목 간 점유율 비교

5. **🔄 총판 비교분석** (`pages/6_🔄_총판_비교분석.py`)
   - 여러 총판 동시 비교
   - 담당 시장 기준 점유율
   - 과목별 점유율 비교

6. **🏅 등급별 분석** (`pages/7_🏅_등급별_분석.py`)
   - 총판 등급별 점유율
   - 등급별 담당 시장 분석
   - 등급 간 성과 비교

---

## 🎓 비즈니스 로직 정리

### 📌 배정 학년 판단 규칙

| 학년도 주문 패턴 | 배정 학년 | 이유 |
|---|---|---|
| 2025년 + 2026년 | **1학년** | 매년 새 1학년에게 공급 |
| 2026년만 | **2학년** | 2학년에 편성 |
| 2025년만 | **1학년** | 1학년에 편성 (한시적) |

### 📌 시장 규모 = 정확한 타겟 학년 학생수

- ❌ **잘못된 방식**: 전체 학생수 사용
- ✅ **올바른 방식**: 해당 도서의 배정 학년 학생수만 사용

---

## 🔧 기술 구현

### 📝 주요 함수

1. **`calculate_market_size_by_subject_v2()`** - 과목별 시장 규모
2. **`calculate_distributor_market_size()`** - 총판별 시장 규모  
3. **`calculate_subject_market_by_distributor()`** - 총판별 과목 시장

### 💾 Session State

```python
st.session_state['market_analysis']  # 과목별 시장 분석
st.session_state['distributor_market']  # 총판별 시장
st.session_state['subject_market_by_dist']  # 총판별 과목 시장
```

---

**마지막 업데이트**: 2025년 12월 17일
